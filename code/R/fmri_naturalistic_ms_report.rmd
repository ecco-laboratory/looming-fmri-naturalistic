---
title: "Manuscript stats for naturalistic loom object fMRI"
format: 
  html:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
require(targets)
require(tidyverse)
require(rlang)
require(knitr)

target_store <- here::here("ignore", "_targets", "naturalistic")
target_store_controlled <- here::here("ignore", "_targets", "controlled")
```

Only the hits! **No analyses should be run here outside of formatting numbers with significant figures. If it requires more transformation, it should be done in a parent target object.**

## Demographics

TODO: N, sex, gender, age

```{r}
participants <- rlang::inject(here::here(!!!path_here_fmri, "participants.tsv")) %>% 
  read_tsv(comment = "#") %>% 
  filter(group %in% c("use_both", "use_naturalistic")) %>% 
  rename(subject = participant_id, gender = sex) %>% 
  # 2025-07-15: NATURALISTIC MANUSCRIPT 1 WILL CONTAIN ONLY DATA FROM SUBJECTS UP TO AND NOT INCLUDING sub-0050
  filter(as.integer(str_split_i(subject, "-", 2)) < 50)
```

N = `r nrow(participants)`

```{r}
participants %>% 
  count(gender) %>% 
  knitr::kable()
```

age, mean = `r round(mean(participants$age), 1)`, SD = `r round(sd(participants$age), 0)`

## Methods descriptive business

### Methods schematic subplots (in Figure 1)

#### Figure 1e

```{r figure-1e-flynet}
knitr::include_graphics(tar_read(fig_ms_schematic_unit.activation_flynet, store = target_store), rel_path = FALSE)
```

```{r figure-1e-alexnet}
knitr::include_graphics(tar_read(fig_ms_schematic_unit.activation_alexnet, store = target_store), rel_path = FALSE)
```

```{r figure-1e-bold}
knitr::include_graphics(tar_read(fig_ms_schematic_bold, store = target_store), rel_path = FALSE)
```

```{r figure-1e-betas-flynet}
knitr::include_graphics(tar_read(fig_ms_schematic_encoding.betas_flynet, store = target_store), rel_path = FALSE)
```

```{r figure-1e-betas-alexnet}
knitr::include_graphics(tar_read(fig_ms_schematic_encoding.betas_alexnet, store = target_store), rel_path = FALSE)
```

## Straight up encoding model performance, cross-validated

```{r}
summary_perf.encoding <- tar_read(summary_perf.encoding, store = target_store) %>% 
  select(encoding_type, starts_with("r_"))

summary_pcor.encoding <- tar_read(summary_pcor.encoding_flynet.alexnet, store = target_store)
```

```{r}
summary_perf.encoding %>% 
  left_join(summary_pcor.encoding, by = "encoding_type") %>% 
  select(-starts_with("r2")) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Figure 2a

```{r figure-2a}
knitr::include_graphics(tar_read(fig_ms_encoding.perf_flynet.alexnet, store = target_store), rel_path = FALSE)
```

## Decoding human-labeled stimulus categories from encoding patterns

```{r}
tar_read(summary_encoding.discrim.looming, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Figure 2b

### looming decoding, separate by each animal type

```{r}
tar_read(summary_encoding.discrim.looming_by.category, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(friedman.test_encoding.discrim.looming_by.category, store = target_store)
```


```{r figure-2b}
knitr::include_graphics(tar_read(fig_ms_encoding.confusion.looming_flynet_by.category, store = target_store), rel_path = FALSE)
```

```{r figure-2b-3}
knitr::include_graphics(tar_read(fig_ms_encoding.auroc.looming_flynet_by.category, store = target_store), rel_path = FALSE)
```

Object decoding definitely done with TRs labeled according to raw video presentation

```{r}
tar_read(summary_encoding.discrim.object, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Figure 2c

```{r figure-2c}
knitr::include_graphics(tar_read(fig_ms_encoding.confusion.object_alexnet, store = target_store), rel_path = FALSE)
```

```{r figure-2c-2}
knitr::include_graphics(tar_read(fig_ms_encoding.auroc.object_alexnet, store = target_store), rel_path = FALSE)
```

### Cross decoding -- can you use the decision variable from one to discriminate the other

#### guessing animal from loom score

```{r}
tar_read(summary_auroc.cross_encoding.discrim.looming, store = target_store) %>% 
  summarize(.estimate_real = mean(.estimate_real)) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```
#### guessing loom from animal scores

```{r}
tar_read(auroc.cross.allway_encoding.discrim.object, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_auroc.cross_encoding.discrim.object, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

## Generalization to controlled task data etc etc

```{r}
n_subjs_controlled <- tar_read(cons_level1.5_controlled, store = target_store) %>% 
  distinct(subj_num) %>% 
  nrow()
```

N who also gave 5 runs of controlled data: `r n_subjs_controlled`

### 1-back task accuracy (for methods benchmark stat)

```{r}
tar_read(beh_controlled, store = target_store) %>% 
  group_by(subj_num) %>% 
  summarize(acc = mean(resp_correct)) %>% 
  summarize(acc_median = median(acc)) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Establishing "ceiling" decoding performance for controlled beta maps

```{r}
tar_read(summary_cons_level1.5_controlled, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_bold.looming.controlled, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_bold.object.controlled, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Naturalistic encoding model performance on controlled beta maps

```{r}
tar_read(summary_pattern.activation.controlled_flynet, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```
```{r}
tar_read(summary_pattern.activation.controlled_alexnet, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(pattern.discrim.controlled_headless_flynet, store = target_store) %>% 
  metrics(truth = direction, estimate = .pred, starts_with("outcome")) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(pattern.discrim.controlled_headless_alexnet, store = target_store) %>% 
  metrics(truth = animal_type, estimate = .pred, starts_with("outcome")) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```


```{r}
tar_read(summary_pattern.discrim.controlled_flynet, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_pattern.discrim.controlled_alexnet, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

## Functional connectivity

```{r}
# Just to make sure these are tracked
targets_statmap <- tar_read(fig_ms_statmaps_pre.mricrogl, store = target_store)
```

```{r}
tar_read(summary_wb.connectivity_sig.sim, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Figure 3d

```{r figure-3d}
knitr::include_graphics(tar_read(fig_ms_conn_sig.sim, store = target_store), rel_path = FALSE)
```

## Self report

### correlations of encoding-decoding classifier variables with self-report

#### Figure 2e

```{r figure-2e}
knitr::include_graphics(tar_read(fig_ms_encoding.decoding.selfreport, store = target_store), rel_path = FALSE)
```
