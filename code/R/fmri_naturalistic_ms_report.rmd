---
title: "Manuscript stats for naturalistic loom object fMRI"
format: 
  html:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
require(targets)
require(tidyverse)
require(rlang)

target_store <- here::here("ignore", "_targets", "naturalistic")
target_store_controlled <- here::here("ignore", "_targets", "controlled")
```

Only the hits! **No analyses should be run here outside of formatting numbers with significant figures. If it requires more transformation, it should be done in a parent target object.**

## Demographics

TODO: N, sex, gender, age

```{r}
participants <- inject(here::here(!!!path_here_fmri, "participants.tsv")) %>% 
  read_tsv() %>% 
  filter(group == "use") %>% 
  rename(subject = participant_id, gender = sex)
```

N = `r nrow(participants)`

```{r}
participants %>% 
  count(gender)
```

age, mean = `r round(mean(participants$age), 0)`, SD = `r round(sd(participants$age), 0)`

## Straight up encoding model performance, cross-validated

```{r}
summary_perf.encoding <- tar_read(summary_perf.encoding, store = target_store) %>% 
  filter(encoding_type %in% c("flynet.only", "alexnet.only")) %>% 
  select(encoding_type, starts_with("r_")) %>% 
  mutate(encoding_type = str_remove(encoding_type, ".only"))

summary_pcor.encoding <- tar_read(summary_pcor.encoding_flynet.alexnet, store = target_store) %>% 
  rename(encoding_type = term)
```

```{r}
summary_perf.encoding %>% 
  left_join(summary_pcor.encoding, by = "encoding_type") %>% 
  select(-starts_with("r2")) %>% 
  mutate(pct_independent = (pcor_mean / r_mean) * 100) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```
```{r}
tar_read(summary_perf.encoding_alexnet.minus.flynet, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Figure 2a

```{r figure-2a}
knitr::include_graphics(tar_read(fig_ms_encoding.perf_flynet.alexnet, store = target_store), rel_path = FALSE)
```

## Decoding human-labeled stimulus categories from encoding patterns

```{r}
tar_read(summary_encoding.discrim.looming, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_encoding.discrim.looming_by.category, store = target_store) %>% 
  filter(.metric %in% c("accuracy", "roc_auc")) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Figure 2b

```{r figure-2b}
knitr::include_graphics(tar_read(fig_ms_encoding.confusion.looming_flynet, store = target_store), rel_path = FALSE)
```

### Supplemental Figure X

Same analysis as Figure 2b but with TRs labeled according to the full duration of videos instead of just the end

```{r figure-supp-0}
knitr::include_graphics(tar_read(fig_ms.supp_encoding.confusion.looming_flynet_events.raw, store = target_store), rel_path = FALSE)
```

Object decoding definitely done with TRs labeled according to raw video presentation

```{r}
tar_read(summary_encoding.discrim.object, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Figure 2c

```{r figure-2c}
knitr::include_graphics(tar_read(fig_ms_encoding.confusion.object_alexnet, store = target_store), rel_path = FALSE)
```

### Cross decoding -- can you use the decision variable from one to discriminate the other

```{r}
tar_read(summary_auroc.cross_encoding.discrim.looming, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(auroc.cross.allway_encoding.discrim.object, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_auroc.cross_encoding.discrim.object, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

## AlexNet predictions on naturalistic stimuli (do AlexNet activations reflect ground-truth human-labeled animal content)

### Supplemental Figure 2

```{r figure-supp-3}
knitr::include_graphics(tar_read(fig_ms.supp_alexnet.guesses, store = target_store), rel_path = FALSE)
```

## Generalization to controlled task data etc etc

### Norm self-report ratings on controlled stimuli

```{r}
tar_read(summary_norms_by.looming, store = target_store_controlled) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_norms_by.object, store = target_store_controlled) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Establishing "ceiling" decoding performance for controlled beta maps

```{r}
tar_read(summary_cons_level1.5_controlled, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_bold.looming.controlled, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_bold.object.controlled, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_bold.object.controlled_by.category, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Comparing controlled beta maps to other Wager CAN Lab associated signatures

```{r}
tar_read(summary_sim.sig.ceko2022, store = target_store_controlled) %>% 
  filter(contrast == "looming") %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Naturalistic encoding model performance on controlled beta maps

```{r}
tar_read(summary_pattern.activation.controlled_flynet, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(summary_pattern.activation.controlled_by.object_flynet, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(pattern.discrim.controlled_alexnet, store = target_store) %>% 
  metrics(truth = animal_type, estimate = animal_type_pred, starts_with("outcome")) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

#### Figure 2d

```{r figure-2d}
knitr::include_graphics(tar_read(fig_ms_pattern.activation.controlled_flynet, store = target_store), rel_path = FALSE)
```

## Functional connectivity

```{r}
# Just to make sure these are tracked
targets_statmap <- tar_read(fig_ms_statmaps_pre.mricrogl, store = target_store)
```

```{r}
tar_read(summary_wb.connectivity_sig.sim, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

### Figure 3b components

```{r figure-3b-1}
knitr::include_graphics(tar_read(fig_ms.supp_ggseg.conn_conj.diff_lat.med, store = target_store), rel_path = FALSE)
```

```{r figure-3b-2}
knitr::include_graphics(tar_read(fig_ms.supp_ggseg.conn_conj.diff_dors.vent, store = target_store), rel_path = FALSE)
```

### Figure 3c

```{r figure-3c}
knitr::include_graphics(tar_read(fig_ms_conn_scatter, store = target_store), rel_path = FALSE)
```

## Self report

### Figure 4a

```{r figure-4a}
knitr::include_graphics(tar_read(fig_ms_ratings, store = target_store), rel_path = FALSE)
```

### ANOVA self report by stimulus labels

```{r}
tar_read(anova_beh_pleasantness, store = target_store) %>% 
  broom.mixed::tidy() %>% 
  mutate(across(c(sumsq, meansq), \(x) round(x, digits = 0)),
         across(c(statistic, p.value), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(anova_beh_arousal, store = target_store) %>% 
  broom.mixed::tidy() %>% 
  mutate(across(c(sumsq, meansq), \(x) round(x, digits = 0)),
         across(c(statistic, p.value), \(x) signif(x, digits = 3)))
```

```{r}
tar_read(anova_beh_fear, store = target_store) %>% 
  broom.mixed::tidy() %>% 
  mutate(across(c(sumsq, meansq), \(x) round(x, digits = 0)),
         across(c(statistic, p.value), \(x) signif(x, digits = 3)))
```

### partial correlations of encoding patterns predicting self-report

```{r}
summary_encoding.selfreport_pcor <- tar_read(summary_encoding.selfreport_pcor, store = target_store) %>% 
  mutate(across(where(is.numeric), \(x) signif(x, digits = 3)))
```

```{r}
summary_encoding.selfreport_pcor %>% 
  filter(data_subset == "overall") %>%
  arrange(term) %>% 
  select(-data_subset)
```

### Figure 4b

```{r figure-4b}
knitr::include_graphics(tar_read(fig_ms_encoding.selfreport.pcor, store = target_store), rel_path = FALSE)
```

```{r}
summary_encoding.selfreport_pcor %>% 
  filter(data_subset == "food") %>% 
  select(-data_subset)
```

## correlations between encoding representation components that predict veridical looming, object, and self report

### Figure 4c

```{r figure-4c}
knitr::include_graphics(tar_read(fig_ms_beta.comparison_object.selfreport, store = target_store), rel_path = FALSE)
```

